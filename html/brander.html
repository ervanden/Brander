<!DOCTYPE html>
<html>
<body onload="wsconnect();  ">

<!--
-->

<style type="text/css">
            * {font-family:Arial, sans-serif;font-size:12px}
            input.white {background-color:white}
            input.green {background-color:green}
            input.grey {background-color:grey}
            input.red {background-color:red}
            button.ON {font-weight: 900;color: rgb(255,0,0); background-color: white; border:none}
            button.OFF {font-weight: 900;color: rgb(0,0,255); background-color: white; border:none}
            button.UNKNOWN {font-weight: 900;color: lightgrey; background-color: white; border:none}



</style>


<input type="text" id="serverAddress" name="serverAddress" class="white" value="ws://X.X.X.X:2603">
<button type="button" id="statusbutton" class="unknownbutton">STATUS ?</button>
<div id="tablediv">
    <table id="schedule">
    </table>
</div>
<button type="button" id="addbutton" class="addbutton">ADD</button>
<button type="button" id="submitbutton" class="submitbutton">SUBMIT</button>
<span id="statusinfo" class="userinfo"></span>
<div id="logdiv"
</div>


<script src="https://code.jquery.com/jquery-1.10.2.js"></script>

<script>



var now=new Date();
var vandaag=now.getDate()+"/"+(now.getMonth()+1)+"/"+now.getFullYear();
g_dagen = ["MONDAY","TUESDAY","WEDNESDAY","THURSDAY","FRIDAY","SATURDAY","SUNDAY",vandaag];

function setStatus(status){
g_statusbutton.data=status;
document.getElementById("statusbutton").className=status;
document.getElementById("statusbutton").innerHTML=g_statusbutton.data;
}

function sendBrander(msg){
  console.log("sending: "+msg);
  g_ws.send(msg);
}

document.getElementById("statusbutton").onclick = function (){
  var command={};
  command.command="getStatus";
  sendBrander(JSON.stringify(command));
}

document.getElementById("addbutton").onclick = function (){
var interval={};
interval.dag=vandaag;
interval.vanuur=0;
interval.vanmin=0;
interval.totuur=23;
interval.totmin=55;
addInterval(interval);
}

document.getElementById("submitbutton").onclick = function (){
var command={};
command.command="putSchedule";
command.arg="reset";
sendBrander(JSON.stringify(command));

for (var i = 0; i < g_table.childNodes.length ; i++) {
  if (g_table.childNodes[i].nodeType==1) { // only element nodes
    command=g_table.childNodes[i].data;
    command.command="putSchedule";
    command.arg="interval";
    sendBrander(JSON.stringify(command));
  }
}
var command={};
command.command="putSchedule";
command.arg="submit";
sendBrander(JSON.stringify(command));
}

function addInterval(data){
  var row = document.createElement('tr');
  g_table.appendChild(row);
  row.data= JSON.parse(JSON.stringify(data));
  var td;
  var button_plus;
  var button_minus;
  var select_dag;
  var select_vanuur;
  var select_vanmin;
  var select_totuur;
  var select_totmin;

  // + button
  td=document.createElement('td');
  row.appendChild(td);
  button_plus= document.createElement('button');
  button_plus.innerHTML="+";
  td.appendChild(button_plus);
  button_plus.onclick = function (){
    addInterval(row.data);
  }

  // - button
  td=document.createElement('td');
  row.appendChild(td);
  button_minus= document.createElement('button');
  button_minus.innerHTML="-";
  td.appendChild(button_minus);
  button_minus.onclick = function (){
    g_table.removeChild(row);
  }

  // dag
  td=document.createElement('td');
  row.appendChild(td);
  select_dag = document.createElement('select');
  td.appendChild(select_dag);
  var selectedOption=false;
  for (var i = 0; i<g_dagen.length; i++){
    var opt = document.createElement('option');
    select_dag.appendChild(opt);
    opt.value = g_dagen[i];
    opt.innerHTML = g_dagen[i];
    if (g_dagen[i]==row.data.dag) {
      opt.selected=true;
      selectedOption=true;
    }
  }
  if (!selectedOption) { // geen weekdag en niet vandaag : dus een andere dag
    var opt = document.createElement('option');
    select_dag.appendChild(opt);
    opt.value = row.data.dag;
    opt.innerHTML = row.data.dag;
    opt.selected=true;
  }

  select_dag.onchange = function() {
    row.data.dag=select_dag.value;
  }

  // 
  td=document.createElement('td');
  row.appendChild(td);
  td.innerHTML="van";

  // van uur
  td=document.createElement('td');
  row.appendChild(td);
  select_vanuur = document.createElement('select');
  td.appendChild(select_vanuur);
  for (var i = 0; i<=23; i++){
    var opt = document.createElement('option');
    select_vanuur.appendChild(opt);
    opt.value = i;
    opt.innerHTML = i;
    if (row.data.vanuur==i) opt.selected=true;
  }
  select_vanuur.onchange = function() {
    row.data.vanuur=select_vanuur.value;
  }

  // :
  td=document.createElement('td');
  row.appendChild(td);
  td.innerHTML=":";

  // van minuut
  td=document.createElement('td');
  row.appendChild(td);
  select_vanmin = document.createElement('select');
  td.appendChild(select_vanmin);
  for (var i = 0; i<=55; i=i+5){
    var opt = document.createElement('option');
    select_vanmin.appendChild(opt);
    opt.value = i;
    opt.innerHTML = i;
    if (row.data.vanmin==i) opt.selected=true;
  }
  select_vanmin.onchange = function() {
    row.data.vanmin=select_vanmin.value;
  }

  // 
  td=document.createElement('td');
  row.appendChild(td);
  td.innerHTML="tot";


  // tot uur
  td=document.createElement('td');
  row.appendChild(td);
  select_totuur = document.createElement('select');
  td.appendChild(select_totuur);
  for (var i = 0; i<=23; i++){
    var opt = document.createElement('option');
    select_totuur.appendChild(opt);
    opt.value = i;
    opt.innerHTML = i;
    if (row.data.totuur==i) opt.selected=true;
  }
  select_totuur.onchange = function() {
    row.data.totuur=select_totuur.value;
  }

  // :
  td=document.createElement('td');
  row.appendChild(td);
  td.innerHTML=":";

  // tot minuut
  td=document.createElement('td');
  row.appendChild(td);
  select_totmin = document.createElement('select');
  td.appendChild(select_totmin);
  for (var i = 0; i<=55; i=i+5){
    var opt = document.createElement('option');
    select_totmin.appendChild(opt);
    opt.value = i;
    opt.innerHTML = i;
    if (row.data.totmin==i) opt.selected=true;
  }
  select_totmin.onchange = function() {
    row.data.totmin=select_totmin.value;
  }
}


                // figure out ip address or host name to construct WebSocket server URL

                var g_serverAddress = window.location.host.split(":", 1)[0];
                g_serverAddress = "ws://" + g_serverAddress + ":4567";
                document.getElementById('serverAddress').value=g_serverAddress;
              
                var g_ws;
                var g_statusbutton=document.getElementById("statusbutton");
                var g_table=document.getElementById("schedule");


                function wsconnect() {

                    if ("WebSocket" in window) {
                        var serverAddress = document.getElementById('serverAddress').value;
                        g_ws = new WebSocket(serverAddress);

                        g_ws.onopen = function () {
                            document.getElementById("serverAddress").className = "green";
                            var msg={};
                            msg.command="getSchedule";
                            sendBrander(JSON.stringify(msg));
                            msg.command="getStatus";
                            sendBrander(JSON.stringify(msg));
                        };

                        g_ws.onclose = function (evt) {
                            document.getElementById("serverAddress").className = "red";
                        };

                        g_ws.onerror = function () {
                            document.getElementById("serverAddress").className = "red";
                        };

                        g_ws.onmessage = function (event) {
                            if (event.data.length > 0) {
                                try {
                                    var obj = JSON.parse(event.data);
                                } catch (e) {
                                    console.log("JSON.parse failed on : " + event.data);

                                }
                                if (typeof obj !== "undefined") {
                                   console.log("received command : " + obj);
                                   console.log(obj);
                                   if (obj.command=="schedule"){
                                      addInterval(obj);
                                   }
                                   if (obj.command=="status"){

                                      setStatus(obj.arg);
                                   }
                                }
                           }
                        }
                    } else {
                        alert("WebSocket NOT supported by your Browser!");
                    }
                }






</script>

</body>
</html>
